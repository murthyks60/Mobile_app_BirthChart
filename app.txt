# app.py
from kivy.app import App
from kivy.uix.boxlayout import BoxLayout
from kivy.uix.gridlayout import GridLayout
from kivy.uix.label import Label
from kivy.uix.textinput import TextInput
from kivy.uix.button import Button
from kivy.uix.scrollview import ScrollView

from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas

import datetime as dt
import pytz
import swisseph as swe
import mobile_main_working_fine as engine
import traceback

# Import your engine functions
# from mobile_main import lookup_city, generate_birth_chart,compute_julian_day, get_sidereal_positions 

""" def format_dms(degrees_float):
    degrees = int(degrees_float)
    minutes_float = (degrees_float - degrees) * 60
    minutes = int(minutes_float)
    seconds = (minutes_float - minutes) * 60
    return f"{degrees}°{minutes:02d}'{seconds:05.2f}\""
"""
""" def get_sign_name(sign_index):
    signs = ["Ar", "Ta", "Ge", "Cn", "Le", "Vi", "Li", "Sc", "Sg", "Cp", "Aq", "Pi"]
    return signs[sign_index % 12] """

class PanchangaScreen(BoxLayout):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.orientation = 'vertical'
        self.padding = 12
        self.spacing = 10

        # Title (dynamic, centered and bold)
        self.title_label = Label(
            text="Birth Chart",
            font_size='22sp',
            bold=True,
            halign="center",
            valign="middle",
            size_hint=(1, None),
            height=50
        )
        self.title_label.bind(size=lambda *args: setattr(self.title_label, 'text_size', self.title_label.size))
        self.add_widget(self.title_label)

        # Input form layout
        form = GridLayout(cols=2, spacing=8, size_hint=(1, None))
        form.bind(minimum_height=form.setter('height'))

        # Name
        form.add_widget(Label(text="Name", size_hint_y=None, height=30))
        self.name_input = TextInput(text="KS Murthy", multiline=False, size_hint_y=None, height=30)
        form.add_widget(self.name_input)

        # City
        form.add_widget(Label(text="City", size_hint_y=None, height=30))
        self.city_input = TextInput(text="Chirala", multiline=False, size_hint_y=None, height=30)
        form.add_widget(self.city_input)

        # DOB
        form.add_widget(Label(text="DOB (YYYY-MM-DD)", size_hint_y=None, height=30))
        self.dob_input = TextInput(text="1960-10-07", multiline=False, size_hint_y=None, height=30)
        form.add_widget(self.dob_input)

        # TOB
        form.add_widget(Label(text="TOB (HH:MM)", size_hint_y=None, height=30))
        self.tob_input = TextInput(text="01:50", multiline=False, size_hint_y=None, height=30)
        form.add_widget(self.tob_input)

        self.add_widget(form)

        # Action buttons
        btn_row = BoxLayout(orientation='horizontal', spacing=10, size_hint=(1, None), height=50)

        self.generate_btn = Button(text="Generate Birth Chart")
        self.generate_btn.bind(on_press=self.on_generate)
        btn_row.add_widget(self.generate_btn)

        self.save_pdf_btn = Button(text="Save as PDF")
        self.save_pdf_btn.bind(on_press=self.on_save_pdf)
        btn_row.add_widget(self.save_pdf_btn)

        self.exit_btn = Button(text="Exit")
        self.exit_btn.bind(on_press=self.on_exit)
        btn_row.add_widget(self.exit_btn)

        self.add_widget(btn_row)

        # Output area (scrollable)
        self.output_scroll = ScrollView(size_hint=(1, 1))
        self.output_label = Label(
            text="",
            size_hint_y=None,
            valign='top'
        )

        self.output_label.bind(texture_size=self._update_text_height)
        self.output_scroll.add_widget(self.output_label)
        self.add_widget(self.output_scroll)
    
    def on_save_pdf(self, *_):
        try:
            preview_text = self.output_label.text

            if not preview_text.strip():
                self.output_label.text += "\n\n⚠️ Nothing to save yet. Generate Birth Chart first."
                return

            filename = "birth_chart_output.pdf"
            c = canvas.Canvas(filename, pagesize=A4)
            width, height = A4

            # Title formatting
            c.setFont("Helvetica-Bold", 16)
            c.drawCentredString(width / 2, height - 50, self.title_label.text)

            # Reset font for body
            c.setFont("Helvetica", 11)

            # Write text line by line
            y = height - 80
            for line in preview_text.split("\n"):
                if line.strip().startswith("**BIRTH CHART"):
                    c.setFont("Helvetica-Bold", 13)
                elif line.strip().endswith(":") or "Details" in line:
                    c.setFont("Helvetica-Bold", 12)
                else:
                    c.setFont("Helvetica", 11)

                c.drawString(50, y, line)
                y -= 15

                # New page if needed
                if y < 50:
                    c.showPage()
                    c.setFont("Helvetica", 11)
                    y = height - 50

            c.save()
            self.output_label.text += f"\n\n✅ Saved as PDF: {filename}"

        except Exception as e:
            self.output_label.text += f"\n\nError saving PDF: {e}"

    def on_exit(self, *_):
        from kivy.app import App
        App.get_running_app().stop()

    def _update_text_height(self, instance, value):
        self.output_label.height = value[1]
        self.output_label.text_size = (self.output_scroll.width - 20, None)

    def on_generate(dob, tob, name, city, lat, lon, utc_offset, jd_ut, sidereal_positions, tz_string):
    # Call the generator from the working module
        chart = engine.generate_birth_chart(
            dob=dob,
            tob=tob,
            name=name,
            city=city,
            lat=lat,
            lon=lon,
            utc_offset=utc_offset,
            jd_ut=jd_ut,
            sidereal_positions=sidereal_positions,
            tz_string=tz_string,
        )
        return chart

class PanchangaApp(App):
    def build(self):
        return PanchangaScreen()

if __name__ == "__main__":
    try:
        PanchangaApp().run()
    except Exception as e:
        print("Error while running PanchangaApp:", e)
        traceback.print_exc()